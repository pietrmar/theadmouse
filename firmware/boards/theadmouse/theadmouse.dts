/*
 * Copyright (c) 2025 Martin Pietryka
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>
#include "theadmouse_partition.dtsi"
#include "theadmouse-pinctrl.dtsi"

/ {
	model = "theadmouse";
	compatible = "mpi,theadmouse";

	aliases {
		red-pwm-led = &red_pwm_led;
		green-pwm-led = &green_pwm_led;
		blue-pwm-led = &blue_pwm_led;
	};

	chosen {
		zephyr,console = &uart0;
		zephyr,shell-uart = &uart0;

		mpi,buttons = &buttons;
		mpi,cmd-uart = &uart_cmd;
		mpi,telemetry-uart = &uart_telemetry;

		mpi,imu = &lsm6dsl;
	};

	buttons: buttons {
		compatible = "gpio-keys";
		debounce-interval-ms = <15>;

		jack1 {
			gpios = <&gpio1 13 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_BTN_0>;
		};

		jack2 {
			gpios = <&gpio1 10 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_BTN_1>;
		};

		jack3 {
			gpios = <&gpio1 11 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_BTN_2>;
		};

		mfb {
			gpios = <&gpio0 2 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_BTN_3>;
		};
	};

	pwmleds {
		compatible = "pwm-leds";

		red_pwm_led: pwm_led_0 {
			pwms = <&pwm0 0 PWM_MSEC(20) PWM_POLARITY_INVERTED>;
		};

		green_pwm_led: pwm_led_1 {
			pwms = <&pwm0 1 PWM_MSEC(20) PWM_POLARITY_INVERTED>;
		};

		blue_pwm_led: pwm_led_2 {
			pwms = <&pwm0 2 PWM_MSEC(20) PWM_POLARITY_INVERTED>;
		};
	};
};

&gpio0 {
	status = "okay";
};

&gpio1 {
	status = "okay";
};

&gpiote {
	status = "okay";
};

&pwm0 {
	status = "okay";
	pinctrl-0 = <&pwm0_default>;
	pinctrl-1 = <&pwm0_sleep>;
	pinctrl-names = "default", "sleep";
};

&pwm1 {
	status = "okay";
	pinctrl-0 = <&pwm1_default>;
	pinctrl-1 = <&pwm1_sleep>;
	pinctrl-names = "default", "sleep";
};

&reg1 {
	regulator-initial-mode = <NRF5X_REG_MODE_DCDC>;
};

&spi0 {
	status = "okay";
	pinctrl-0 = <&spi0_default>;
	pinctrl-1 = <&spi0_sleep>;
	pinctrl-names = "default", "sleep";

	cs-gpios = <&gpio0 10 GPIO_ACTIVE_LOW>,	// SENS_IMU_CS
		   <&gpio0 3 GPIO_ACTIVE_LOW>;	// SENS_MAG_CS

	lsm6dsl: lsm6dsl@0 {
		compatible = "st,lsm6dsl";
		reg = <0>;
		spi-max-frequency = <10000000>;
		irq-gpios = <&gpio0 30 GPIO_ACTIVE_HIGH>;
	};

	lis2mdl: lis2mdl@1 {
		compatible = "st,lis2mdl";
		reg = <1>;
		spi-max-frequency = <10000000>;
		// In 4-wire SPI mode the DRDY signal is MISO
		// irq-gpios = <&gpio0 29 GPIO_ACTIVE_HIGH>;
	};
};

&uart0 {
	status = "okay";
	current-speed = <115200>;
	pinctrl-0 = <&uart0_default>;
	pinctrl-1 = <&uart0_sleep>;
	pinctrl-names = "default", "sleep";
};

&uicr {
	nfct-pins-as-gpios;
};

&usbd {
	status = "okay";

	// FABI style AT configuration interface
	uart_cmd: cdc_acm_uart0 {
		compatible = "zephyr,cdc-acm-uart";
	};

	// Data stream from the IMU, magnetometer, filter output, etc. used
	// for debugging and visualization
	uart_telemetry: cdc_acm_uart1 {
		compatible = "zephyr,cdc-acm-uart";
	};
};
